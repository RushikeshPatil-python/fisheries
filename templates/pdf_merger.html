<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Merger â€” Streaming Download</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f2f4f7; padding:30px; }
    .container-box { background:#fff; padding:30px 40px; border-radius:12px; max-width:800px; margin:auto; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
    .spinner-border { width:1.1rem; height:1.1rem; }
    #progressBar { height: 18px; }
    .small-muted { font-size:0.85rem; color:#6c757d; }
  </style>
</head>
<body>

<div class="container-box">
  <h3 class="text-center mb-4">PDF Merger (Streaming Download)</h3>

  <!-- File picker -->
  <div class="mb-3">
    <label class="form-label">Select PDFs (in the exact order you want)</label>
    <input type="file" id="pdfInput" accept="application/pdf" multiple class="form-control">
    <div class="small-muted mt-1">Files shown in selection order. Remove if needed.</div>
  </div>

  <!-- Selected files list -->
  <ul id="pdfList" class="list-group mb-3" style="max-height:220px; overflow:auto;"></ul>

  <!-- Merge / Download button -->
  <div class="d-grid gap-2">
    <button id="mergeBtn" class="btn btn-primary" onclick="mergePDFs()">Merge & Download</button>
  </div>

  <!-- Progress UI -->
  <div id="progressWrap" class="mt-3" style="display:none;">
    <div class="d-flex justify-content-between mb-1">
      <div id="progressLabel">Downloading...</div>
      <div id="progressPct">0%</div>
    </div>
    <div class="progress">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
    </div>
    <div class="small-muted mt-2" id="progressBytes"></div>
  </div>
</div>

<script>
  // preserves selection order and original filenames
  let orderedFiles = [];

  const pdfInput = document.getElementById('pdfInput');
  const pdfList = document.getElementById('pdfList');
  const mergeBtn = document.getElementById('mergeBtn');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');
  const progressPct = document.getElementById('progressPct');
  const progressLabel = document.getElementById('progressLabel');
  const progressBytes = document.getElementById('progressBytes');

  pdfInput.addEventListener('change', (e) => {
    const added = Array.from(e.target.files);
    added.forEach(f => orderedFiles.push(f));
    renderList();
  });

  function renderList() {
    pdfList.innerHTML = '';
    orderedFiles.forEach((file, idx) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <div>
          <strong>${idx + 1}.</strong> ${escapeHtml(file.name)}
          <div class="small-muted">${(file.size/1024).toFixed(1)} KB</div>
        </div>
        <div>
          <button class="btn btn-sm btn-danger" onclick="removeFile(${idx})">Remove</button>
        </div>
      `;
      pdfList.appendChild(li);
    });
  }

  function removeFile(index) {
    orderedFiles.splice(index,1);
    renderList();
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function mergePDFs() {
    if (orderedFiles.length === 0) { alert('Select at least one PDF'); return; }
    mergeBtn.disabled = true;
    mergeBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Merging...`;

    const formData = new FormData();
    // append using real filenames, in the selected order
    orderedFiles.forEach(f => formData.append('files', f, f.name));

    try {
      const response = await fetch('/merge-pdfs', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const text = await response.text().catch(()=>null);
        throw new Error(`Server returned ${response.status}${text ? ': '+text : ''}`);
      }

      // get filename from header (fallback to merged.pdf)
      let filename = 'merged.pdf';
      const cd = response.headers.get('Content-Disposition');
      if (cd) {
        const m = cd.match(/filename="?([^"]+)"?/);
        if (m) filename = m[1];
      }

      // Show progress UI
      progressWrap.style.display = 'block';
      progressLabel.textContent = 'Downloading...';
      progressBar.style.width = '0%';
      progressPct.textContent = '0%';
      progressBytes.textContent = '';

      // If content-length present we can show percent
      const contentLengthHeader = response.headers.get('Content-Length');
      const total = contentLengthHeader ? parseInt(contentLengthHeader, 10) : null;

      const reader = response.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;

        if (total) {
          const pct = Math.round((received / total) * 100);
          progressBar.style.width = pct + '%';
          progressPct.textContent = pct + '%';
        } else {
          // approximate / animate if total unknown
          progressPct.textContent = `${(received/1024).toFixed(0)} KB`;
        }
        progressBytes.textContent = total ? `${(received/1024).toFixed(1)} KB / ${(total/1024).toFixed(1)} KB` : `${(received/1024).toFixed(1)} KB received`;
      }

      // assemble blob and trigger download
      const blob = new Blob(chunks, { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();

      // cleanup
      setTimeout(() => URL.revokeObjectURL(url), 2000);

      // reset UI & list
      orderedFiles = [];
      renderList();
      pdfInput.value = '';
      progressLabel.textContent = 'Download complete';
      progressPct.textContent = '100%';

    } catch (err) {
      console.error('Merge/download failed', err);
      alert('Error: ' + (err.message || err));
      progressLabel.textContent = 'Failed';
    } finally {
      mergeBtn.disabled = false;
      mergeBtn.innerHTML = 'Merge & Download';
      // optionally hide progress after a while
      setTimeout(()=>{ progressWrap.style.display = 'none'; }, 3000);
    }
  }
</script>
</body>
</html>