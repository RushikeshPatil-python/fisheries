<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Merge PDFs</title>

    <!-- Bootstrap CSS -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <style>
        body {
            background: #f2f4f7;
            padding: 30px;
        }
        .container-box {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            max-width: 700px;
            margin: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .spinner-border {
            width: 1.2rem;
            height: 1.2rem;
        }
    </style>
</head>
<body>

<div class="container-box">

    <h3 class="text-center mb-4">PDF Merger</h3>

    <!-- File picker -->
    <div class="mb-3">
        <label class="form-label">Select PDFs (in the exact order you want)</label>
        <input type="file" id="pdfInput" accept="application/pdf" multiple class="form-control">
    </div>

    <!-- List files in the order selected -->
    <ul id="pdfList" class="list-group mb-3"></ul>

    <!-- Merge button -->
    <button id="mergeBtn" class="btn btn-primary w-100" onclick="mergePDFs()">
        Merge PDFs
    </button>

</div>

<script>
    let orderedFiles = [];  // Stores selected files in correct order

    // When user selects PDFs
    document.getElementById("pdfInput").addEventListener("change", function (event) {
        const selected = Array.from(event.target.files);

        // Append selected files in sequence
        selected.forEach(file => orderedFiles.push(file));

        // Update list UI
        renderList();
    });

    // Show selected PDFs with remove option
    function renderList() {
        const list = document.getElementById("pdfList");
        list.innerHTML = "";

        orderedFiles.forEach((file, index) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";

            li.innerHTML = `
                <span>${index + 1}. ${file.name}</span>
                <button class="btn btn-danger btn-sm" onclick="removeFile(${index})">Remove</button>
            `;

            list.appendChild(li);
        });
    }

    // Remove a selected file
    function removeFile(index) {
        orderedFiles.splice(index, 1);
        renderList();
    }

    // Send PDFs to backend with original filenames
    async function mergePDFs() {
        if (orderedFiles.length === 0) {
            alert("Please select at least one PDF.");
            return;
        }

        const mergeBtn = document.getElementById("mergeBtn");
        mergeBtn.disabled = true;
        mergeBtn.innerHTML = `<span class="spinner-border"></span> Merging...`;

        const formData = new FormData();

        // Append files with REAL names
        orderedFiles.forEach((file) => {
            formData.append("files", file, file.name);
        });

        try {
            const response = await fetch("/merge-pdfs", {
                method: "POST",
                body: formData
            });

            if (!response.ok) {
                alert("Merge failed.");
                mergeBtn.disabled = false;
                mergeBtn.innerHTML = "Merge PDFs";
                return;
            }

            // Download merged PDF
            let filename = "merged.pdf";
            const cd = response.headers.get("Content-Disposition");
            if (cd) {
                const match = cd.match(/filename="([^"]+)"/);
                if (match) {
                    filename = match[1];
                }
            }

            // Download using the correct filename
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();

            setTimeout(() => URL.revokeObjectURL(url), 2000);


            // Reset UI
            orderedFiles = [];
            renderList();
            document.getElementById("pdfInput").value = "";

        } catch (error) {
            alert("Error merging files.");
        }

        mergeBtn.disabled = false;
        mergeBtn.innerHTML = "Merge PDFs";
    }
</script>

</body>
</html>
